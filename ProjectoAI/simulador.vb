Public Class simulador
    'inicializa o array das imagens
    Function initImgs()
        Imagem(168) = Me._Imagem_168
        Imagem(167) = Me._Imagem_167
        Imagem(166) = Me._Imagem_166
        Imagem(165) = Me._Imagem_165
        Imagem(164) = Me._Imagem_164
        Imagem(163) = Me._Imagem_163
        Imagem(162) = Me._Imagem_162
        Imagem(161) = Me._Imagem_161
        Imagem(160) = Me._Imagem_160
        Imagem(159) = Me._Imagem_159
        Imagem(158) = Me._Imagem_158
        Imagem(157) = Me._Imagem_157
        Imagem(156) = Me._Imagem_156
        Imagem(155) = Me._Imagem_155
        Imagem(154) = Me._Imagem_154
        Imagem(153) = Me._Imagem_153
        Imagem(152) = Me._Imagem_152
        Imagem(151) = Me._Imagem_151
        Imagem(150) = Me._Imagem_150
        Imagem(149) = Me._Imagem_149
        Imagem(148) = Me._Imagem_148
        Imagem(147) = Me._Imagem_147
        Imagem(146) = Me._Imagem_146
        Imagem(145) = Me._Imagem_145
        Imagem(144) = Me._Imagem_144
        Imagem(143) = Me._Imagem_143
        Imagem(142) = Me._Imagem_142
        Imagem(141) = Me._Imagem_141
        Imagem(140) = Me._Imagem_140
        Imagem(139) = Me._Imagem_139
        Imagem(138) = Me._Imagem_138
        Imagem(137) = Me._Imagem_137
        Imagem(136) = Me._Imagem_136
        Imagem(135) = Me._Imagem_135
        Imagem(134) = Me._Imagem_134
        Imagem(133) = Me._Imagem_133
        Imagem(132) = Me._Imagem_132
        Imagem(131) = Me._Imagem_131
        Imagem(130) = Me._Imagem_130
        Imagem(129) = Me._Imagem_129
        Imagem(128) = Me._Imagem_128
        Imagem(127) = Me._Imagem_127
        Imagem(126) = Me._Imagem_126
        Imagem(125) = Me._Imagem_125
        Imagem(124) = Me._Imagem_124
        Imagem(123) = Me._Imagem_123
        Imagem(122) = Me._Imagem_122
        Imagem(121) = Me._Imagem_121
        Imagem(120) = Me._Imagem_120
        Imagem(119) = Me._Imagem_119
        Imagem(118) = Me._Imagem_118
        Imagem(117) = Me._Imagem_117
        Imagem(116) = Me._Imagem_116
        Imagem(115) = Me._Imagem_115
        Imagem(114) = Me._Imagem_114
        Imagem(113) = Me._Imagem_113
        Imagem(112) = Me._Imagem_112
        Imagem(111) = Me._Imagem_111
        Imagem(110) = Me._Imagem_110
        Imagem(109) = Me._Imagem_109
        Imagem(108) = Me._Imagem_108
        Imagem(107) = Me._Imagem_107
        Imagem(106) = Me._Imagem_106
        Imagem(105) = Me._Imagem_105
        Imagem(104) = Me._Imagem_104
        Imagem(103) = Me._Imagem_103
        Imagem(102) = Me._Imagem_102
        Imagem(101) = Me._Imagem_101
        Imagem(100) = Me._Imagem_100
        Imagem(99) = Me._Imagem_99
        Imagem(98) = Me._Imagem_98
        Imagem(97) = Me._Imagem_97
        Imagem(96) = Me._Imagem_96
        Imagem(95) = Me._Imagem_95
        Imagem(94) = Me._Imagem_94
        Imagem(93) = Me._Imagem_93
        Imagem(92) = Me._Imagem_92
        Imagem(91) = Me._Imagem_91
        Imagem(90) = Me._Imagem_90
        Imagem(89) = Me._Imagem_89
        Imagem(88) = Me._Imagem_88
        Imagem(87) = Me._Imagem_87
        Imagem(86) = Me._Imagem_86
        Imagem(85) = Me._Imagem_85
        Imagem(84) = Me._Imagem_84
        Imagem(83) = Me._Imagem_83
        Imagem(82) = Me._Imagem_82
        Imagem(81) = Me._Imagem_81
        Imagem(80) = Me._Imagem_80
        Imagem(79) = Me._Imagem_79
        Imagem(78) = Me._Imagem_78
        Imagem(77) = Me._Imagem_77
        Imagem(76) = Me._Imagem_76
        Imagem(75) = Me._Imagem_75
        Imagem(74) = Me._Imagem_74
        Imagem(73) = Me._Imagem_73
        Imagem(72) = Me._Imagem_72
        Imagem(71) = Me._Imagem_71
        Imagem(70) = Me._Imagem_70
        Imagem(69) = Me._Imagem_69
        Imagem(68) = Me._Imagem_68
        Imagem(67) = Me._Imagem_67
        Imagem(66) = Me._Imagem_66
        Imagem(65) = Me._Imagem_65
        Imagem(64) = Me._Imagem_64
        Imagem(63) = Me._Imagem_63
        Imagem(62) = Me._Imagem_62
        Imagem(61) = Me._Imagem_61
        Imagem(60) = Me._Imagem_60
        Imagem(59) = Me._Imagem_59
        Imagem(58) = Me._Imagem_58
        Imagem(57) = Me._Imagem_57
        Imagem(56) = Me._Imagem_56
        Imagem(55) = Me._Imagem_55
        Imagem(54) = Me._Imagem_54
        Imagem(53) = Me._Imagem_53
        Imagem(52) = Me._Imagem_52
        Imagem(51) = Me._Imagem_51
        Imagem(50) = Me._Imagem_50
        Imagem(49) = Me._Imagem_49
        Imagem(48) = Me._Imagem_48
        Imagem(47) = Me._Imagem_47
        Imagem(46) = Me._Imagem_46
        Imagem(45) = Me._Imagem_45
        Imagem(44) = Me._Imagem_44
        Imagem(43) = Me._Imagem_43
        Imagem(42) = Me._Imagem_42
        Imagem(41) = Me._Imagem_41
        Imagem(40) = Me._Imagem_40
        Imagem(39) = Me._Imagem_39
        Imagem(38) = Me._Imagem_38
        Imagem(37) = Me._Imagem_37
        Imagem(36) = Me._Imagem_36
        Imagem(35) = Me._Imagem_35
        Imagem(34) = Me._Imagem_34
        Imagem(33) = Me._Imagem_33
        Imagem(32) = Me._Imagem_32
        Imagem(31) = Me._Imagem_31
        Imagem(30) = Me._Imagem_30
        Imagem(29) = Me._Imagem_29
        Imagem(28) = Me._Imagem_28
        Imagem(27) = Me._Imagem_27
        Imagem(26) = Me._Imagem_26
        Imagem(25) = Me._Imagem_25
        Imagem(24) = Me._Imagem_24
        Imagem(23) = Me._Imagem_23
        Imagem(22) = Me._Imagem_22
        Imagem(21) = Me._Imagem_21
        Imagem(20) = Me._Imagem_20
        Imagem(19) = Me._Imagem_19
        Imagem(18) = Me._Imagem_18
        Imagem(17) = Me._Imagem_17
        Imagem(16) = Me._Imagem_16
        Imagem(15) = Me._Imagem_15
        Imagem(14) = Me._Imagem_14
        Imagem(13) = Me._Imagem_13
        Imagem(12) = Me._Imagem_12
        Imagem(11) = Me._Imagem_11
        Imagem(10) = Me._Imagem_10
        Imagem(9) = Me._Imagem_9
        Imagem(8) = Me._Imagem_8
        Imagem(7) = Me._Imagem_7
        Imagem(6) = Me._Imagem_6
        Imagem(5) = Me._Imagem_5
        Imagem(4) = Me._Imagem_4
        Imagem(3) = Me._Imagem_3
        Imagem(2) = Me._Imagem_2
        Imagem(1) = Me._Imagem_1
        Imagem(0) = Me._Imagem_0
    End Function

    'Desenha o ambiente do painel.
    Function desenhaCenario()
        Dim pos As Integer
        Call putCenario()

        For pos = 0 To nPosicoes
            Imagem(pos).BorderStyle = BorderStyle.None
            Imagem(pos).Image = getImagem(cenario(pos), -1)
        Next
    End Function

    'Desenha os elementos da aplicação
    Function desenhaElementos()
        Dim pos As Integer

        For pos = 0 To nPosicoes
            If temElemento(pos) Then
                Imagem(pos).Image = getImagem(elementos(pos), cenario(pos))
            End If
        Next
    End Function

    'desenha os quarteis
    Function desenhaQuarteis(ByVal n As Integer) As Boolean
        If n > 10 Then
            MsgBox("O número de quarteis está limitado a 10.")
            Return False
        End If
        Dim i As Integer

        For i = 1 To n
            Call desenhaQuartel()
        Next
        Call refresca()
    End Function

    'desenha um quartel
    Function desenhaQuartel()
        Dim pos As Integer
        Dim rand As New Random(System.DateTime.Now.Millisecond)

        While (putQuartel(rand.Next(0, nPosicoes)) = False)
        End While

    End Function

    'desenha os bombeiros
    Function desenhaBombeiros(ByVal n As Integer)
        If n > 10 Then
            MsgBox("O número de bombeiros está limitado a 10.")
            Return False
        End If
        Dim i As Integer

        For i = 1 To n
            Call desenhaBombeiro()
        Next
        Call refresca()
    End Function


    'desenha um bombeiro
    Function desenhaBombeiro()
        Dim pos As Integer
        Dim rand As New Random(System.DateTime.Now.Millisecond)

        While (putBombeiro(rand.Next(0, nPosicoes)) = False)
        End While

        Call refresca()
    End Function

    'Começa uma serie de incendios
    Function startFogos()
        cronoIncendios.Enabled = True
        startApagaIncendio()
    End Function

    'pára os incendios
    Function stopFogos()
        cronoIncendios.Enabled = False
    End Function

    'começa um incendio
    Private Sub startIncendio(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cronoIncendios.Tick
        Dim intervalo As New Random(System.DateTime.Now.Millisecond)
        cronoIncendios.Interval = intervalo.Next(2000, 10000)

        Dim pos As Integer
        Dim rand As New Random(System.DateTime.Now.Millisecond)

        While (putFogo(rand.Next(0, nPosicoes)) = False)
        End While

        Call refresca()
    End Sub

    'inicia o apagamento dos incendios
    Function startApagaIncendio()
        cronoBombeiros.Interval = 1000
        cronoBombeiros.Enabled = True
    End Function

    'pára o apagamentos dos incendios
    Function stopApagaIncendio()
        cronoBombeiros.Enabled = False
    End Function

    Private Sub ApagaIncendio(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cronoBombeiros.Tick
        Call moveBombeiros()
        Call refresca()
    End Sub

    'faz o refrescamento do painel
    Function refresca()
        Dim i As Integer
        Call desenhaCenario()
        Call desenhaElementos()
        Call actualizaLabels()
        For i = 0 To nPosicoes
            If (elementos(i) = bombeiroCAgua) Then
                elementos(i) = bombeiroSAgua
            End If
        Next
    End Function

    'inicia o simulador.
    Private Sub iniciar(ByVal eventSender As System.Object, ByVal eventArgs As System.EventArgs) Handles iniciar_botao.Click

        'Inicializa a interface com o 'sicstus prolog 3.9.1.'
        Call StartProlog("trabalho")
        'Inicializa o array com as posicoes do painel
        Call initImgs()
        'limpa o array dos elementos
        Call limpa()
        'desenha o ambiente do simulador.
        Call desenhaCenario()
        'desenha os quarteis dos bombeiros.
        Call desenhaQuarteis(Me.nquarteis.Text)
        'desenha os bombeiros que circulam pelo cenário
        Call desenhaBombeiros(Me.nbombeiros.Text)
        'dá inicio á sessão de fogos
        Call startFogos()
        Me.bombeiros.Text = "Bombeiros: " & 0
        Me.quarteis.Text = "Quarteis: " & 0
        Me.carros.Text = "Carros: " & 0
        Me.fogosa.Text = "Fogos Activos: " & 0
        Me.fogose.Text = "Fogos Extintos: " & 0
        contafogos = 0

    End Sub

    'Método utilizado para fechar o programa.
    Private Sub sair(ByVal eventSender As System.Object, ByVal eventArgs As System.EventArgs) Handles sair_botao.Click
        Dim resp As Integer
        resp = MsgBox("Tem a certeza de que deseja sair?", MsgBoxStyle.YesNo, "Exit")
        If (resp = MsgBoxResult.Yes) Then
            End
        End If
    End Sub

    Private Sub painel_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load
        Me.bombeiros.Text = "Bombeiros: " & 0
        Me.quarteis.Text = "Quarteis: " & 0
        Me.carros.Text = "Carros: " & 0
        Me.fogosa.Text = "Fogos Activos: " & 0
        Me.fogose.Text = "Fogos Extintos: " & 0
    End Sub
    Function actualizaLabels()
        Dim fogosActivos As Integer
        fogosActivos = totalFogosActivos()

        Me.fogosa.Text = "Fogos Activos: " & fogosActivos
        Me.fogose.Text = "Fogos Extintos: " & contafogos - fogosActivos
        Me.bombeiros.Text = "Bombeiros: " & totalBombeirosActivos()
        Me.quarteis.Text = "Quarteis: " & Me.nquarteis.Text
        Me.carros.Text = "Carros: " & totalCarrosActivos()

    End Function

    Private Sub parar_botao_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles parar_botao.Click
        Call stopApagaIncendio()
        Call stopFogos()
    End Sub
End Class